<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CVPD Contacts Report — GitHub Pages host</title>
  <link rel="preconnect" href="https://live.zwidgets.com">
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 24px; background:#fff; color:#222; }
    h2 { margin-top:0; }
    .ok { color:#2e7d32; font-weight:600; }
    .warn { color:#ef6c00; font-weight:600; }
    .muted { color:#666; }
    button { padding:10px 14px; border:1px solid #999; border-radius:8px; cursor:pointer; background:#f5f5f5; }
    .card { border:1px solid #ddd; padding:16px; border-radius:12px; max-width:720px; }
  </style>
</head>
<body>
  <h2>CVPD Contacts Report — GitHub Pages host</h2>
  <div class="card">
    <div id="status" class="muted">Loading Zoho SDK…</div>
    <div style="margin-top:12px;">
      <button id="test">Run SDK test</button>
    </div>
    <p class="muted" style="margin-top:12px;">
      Tip: This page should be opened by a Zoho CRM button set to <b>Open a Widget</b> (popup),
      so the SDK can initialize.
    </p>
  </div>

  <!-- Error catchers so we never see a blank screen -->
  <script>
  window.addEventListener("error", e => {
    document.body.innerHTML =
      "<div style='font-family:system-ui;padding:20px;color:#b71c1c'>" +
      "<h2>⚠️ Runtime Error</h2>" +
      "<pre style='white-space:pre-wrap'>" + (e.error?.stack || e.message) + "</pre></div>";
  });
  window.addEventListener("unhandledrejection", e => {
    document.body.innerHTML =
      "<div style='font-family:system-ui;padding:20px;color:#b71c1c'>" +
      "<h2>⚠️ Promise Rejection</h2>" +
      "<pre style='white-space:pre-wrap'>" + (e.reason?.stack || e.reason) + "</pre></div>";
  });
  </script>

  <script>
  (async () => {
    const el = document.getElementById('status');
    const set = (cls, msg) => { el.className = cls; el.textContent = msg; };

    const getZoho = () => {
      try { return window.ZOHO || (window.parent && window.parent.ZOHO) || null; }
      catch { return window.ZOHO || null; }
    };

    function loadScript(src, label) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.onload = () => resolve(label || src);
        s.onerror = () => reject(new Error('Failed to load ' + (label || src)));
        document.head.appendChild(s);
      });
    }

    async function ensureSdk() {
      let Z = getZoho();
      if (Z) return { Z, how: 'parent' };
      try {
        await loadScript('https://live.zwidgets.com/sdk/v1/js/ZohoEmbededAppSDK.min.js', 'sdk-v1');
        Z = getZoho();
        if (Z) return { Z, how: 'cdn-v1' };
      } catch(e) { /* ignore */ }
      try {
        await loadScript('https://live.zwidgets.com/js-sdk/1.3/ZohoEmbededAppSDK.min.js', 'cdn-1.3');
        Z = getZoho();
        if (Z) return { Z, how: 'cdn-1.3' };
      } catch(e) { /* ignore */ }
      return { Z: null, how: 'none' };
    }

    try {
      set('muted', 'Initializing…');
      const { Z, how } = await ensureSdk();
      if (!Z) {
        set('warn', 'Not in Zoho popup (ZOHO is undefined). SDK could not be loaded (blocked by sandbox/CSP).');
        return;
      }
      await Z.embeddedApp.init();
      set('ok', '✅ SDK OK — source: ' + how);

      // Bind test button (uses ORG namespace; falls back to API if present)
      document.getElementById('test')?.addEventListener('click', async () => {
        try {
          if (Z?.CRM?.ORG?.getOrgInfo) {
            const info = await Z.CRM.ORG.getOrgInfo();
            alert('Org OK: ' + (info?.org?.[0]?.company_name || JSON.stringify(info)));
          } else if (Z?.CRM?.API?.getOrgInfo) {
            const info = await Z.CRM.API.getOrgInfo();
            alert('Org OK: ' + (info?.org?.[0]?.company_name || JSON.stringify(info)));
          } else {
            alert('API failed: getOrgInfo not available on this SDK build.');
          }
        } catch (e) {
          alert('API failed: ' + (e && e.message ? e.message : e));
        }
      });
    } catch(e) {
      set('warn', 'SDK init failed: ' + (e && e.message ? e.message : e));
    }
  })();
  </script>
</body>
</html>
