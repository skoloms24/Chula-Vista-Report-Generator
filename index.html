<script>
(async () => {
  const el = document.getElementById('status');
  const set = (cls, msg) => { el.className = cls; el.textContent = msg; };

  // Safe getter that won’t throw on cross-origin parents
  const getZoho = () => {
    try { return window.ZOHO || (window.parent && window.parent.ZOHO) || null; }
    catch { return window.ZOHO || null; }
  };

  function loadScript(src, label) {
    return new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = src;
      s.onload = () => resolve(label || src);
      s.onerror = () => reject(new Error('Failed to load: ' + (label || src)));
      document.head.appendChild(s);
    });
  }

  async function ensureSdk() {
    let Z = getZoho();
    if (Z) return { Z, how: 'parent' };

    // Try primary CDN
    try {
      await loadScript('https://live.zwidgets.com/sdk/v1/js/ZohoEmbededAppSDK.min.js', 'sdk v1');
      Z = getZoho();
      if (Z) return { Z, how: 'cdn-v1' };
    } catch (e) { /* fall through */ }

    // Try legacy path (some orgs only allow this)
    try {
      await loadScript('https://live.zwidgets.com/js-sdk/1.3/ZohoEmbededAppSDK.min.js', 'sdk 1.3');
      Z = getZoho();
      if (Z) return { Z, how: 'cdn-1.3' };
    } catch (e) { /* fall through */ }

    return { Z: null, how: 'none' };
  }

  try {
    set('muted', 'Initializing…');
    const { Z, how } = await ensureSdk();
    if (!Z) {
      set('warn', 'Not in Zoho popup (ZOHO is undefined). SDK could not be loaded (blocked by sandbox/CSP).');
      return;
    }
    await Z.embeddedApp.init();
    set('ok', '✅ SDK OK — source: ' + how);

    document.getElementById('test').onclick = async () => {
      try {
        const info = await Z.CRM.API.getOrgInfo();
        alert('Org OK: ' + (info?.org?.[0]?.company_name || 'response received'));
      } catch (e) {
        alert('API failed: ' + (e && e.message ? e.message : e));
      }
    };
  } catch (e) {
    set('warn', 'SDK init failed: ' + (e && e.message ? e.message : e));
  }
})();
</script>
