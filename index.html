<script>
(async () => {
  const el = document.getElementById('status');
  const set = (cls, msg) => { el.className = cls; el.textContent = msg; };

  // 1) Try to use SDK from parent (works in "Open a Widget" popups)
  const getZoho = () => window.ZOHO || (window.parent && window.parent.ZOHO) || null;
  let Z = getZoho();

  // 2) If not present, dynamically load the SDK (works in "Open URL → Popup")
  async function ensureSdk() {
    Z = getZoho();
    if (Z) return Z;
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = 'https://live.zwidgets.com/sdk/v1/js/ZohoEmbededAppSDK.min.js';
      s.onload = resolve;
      s.onerror = () => reject(new Error('SDK script failed to load'));
      document.head.appendChild(s);
    });
    Z = getZoho();
    return Z;
  }

  try {
    set('muted', 'Initializing…');
    Z = await ensureSdk();
    if (!Z) {
      set('warn', 'Not in Zoho popup (ZOHO is undefined). The page is loaded, but SDK is unavailable.');
      return;
    }
    await Z.embeddedApp.init();
    set('ok', '✅ SDK OK — running inside Zoho.');
    document.getElementById('test').onclick = async () => {
      try {
        const info = await Z.CRM.API.getOrgInfo();
        alert('Org OK: ' + (info?.org?.[0]?.company_name || 'response received'));
      } catch (e) {
        alert('API failed: ' + (e && e.message ? e.message : e));
      }
    };
  } catch (e) {
    set('warn', 'SDK init failed: ' + (e && e.message ? e.message : e));
  }
})();
</script>
